<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documents</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f0f8ff; }

header {
    background:#0B3D91;
    color:white;
    padding:15px 20px;
    display:flex;
    align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
header h1 {
    margin:0;
    font-size:1.5em;
    flex-grow:1;
    text-align:center;
}
.back-symbol {
    font-size:1.4em;
    cursor:pointer;
    margin-right:10px;
    user-select:none;
}

.container {
    max-width:800px;
    margin:20px auto;
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px;
}

.button {
    display:flex;
    align-items:center;
    justify-content:center;
    background:white;
    color:#0B3D91;
    padding:20px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
    text-align:center;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s, background 0.2s;
}
.button:hover {
    transform:translateY(-3px);
    background:#e6f2ff;
}

.file-card {
    display:flex;
    align-items:center;
    background:white;
    color:#0B3D91;
    padding:15px 20px;
    margin:6px 0;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s, background 0.2s;
    grid-column:1 / -1;
}
.file-card:hover {
    transform:translateY(-2px);
    background:#e6f2ff;
}

#previewContainer {
    width:100%;
    height:100vh;
    position:fixed;
    top:0;
    left:0;
    background:white;
    display:none;
    z-index:1000;
}
#previewContainer iframe {
    width:100%;
    height:100%;
    border:none;
}
#closePreview {
    position:absolute;
    top:10px;
    right:10px;
    background:#f44336;
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    z-index:1001;
}
#closePreview:hover {
    background:#d32f2f;
}
</style>
</head>

<body>

<header>
    <span id="backBtn" class="back-symbol" style="display:none;">←</span>
    <h1>Fincep</h1>
</header>

<div class="container" id="content"></div>

<div id="previewContainer">
    <button id="closePreview">Close ✖</button>
    <iframe id="previewIframe"></iframe>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCBFObaNdHuPDVM3eo-1qtJ0ENQ3vf1oOc",
  authDomain: "finceponlinetuitions.firebaseapp.com",
  projectId: "finceponlinetuitions",
  storageBucket: "finceponlinetuitions.appspot.com",
  messagingSenderId: "562071475466",
  appId: "1:562071475466:web:182cb7c22b64729dd16f3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selectedSubject = null;
let selectedGrade = null;
let selectedMainTopic = null;

const content = document.getElementById("content");
const backBtn = document.getElementById("backBtn");
const previewContainer = document.getElementById("previewContainer");
const previewIframe = document.getElementById("previewIframe");
const closePreview = document.getElementById("closePreview");

closePreview.onclick = () => {
    previewContainer.style.display = "none";
    previewIframe.src = "";
};

backBtn.onclick = () => {
    if(selectedMainTopic){
        selectedMainTopic = null;
        loadFiles();
    } else if(selectedGrade){
        selectedGrade = null;
        loadFiles();
    } else {
        selectedSubject = null;
        loadSubjects();
    }
};

// ---- SUBJECTS ----
function loadSubjects(){
    content.innerHTML = "";
    backBtn.style.display = "none";

    db.collection("documents").get().then(snapshot=>{
        const subjects = [...new Set(snapshot.docs.map(d => d.data().subject))];
        subjects.sort();

        if(subjects.length === 0){
            content.innerHTML = "<p>No documents uploaded yet.</p>";
            return;
        }

        subjects.forEach(subject=>{
            const btn = document.createElement("button");
            btn.className = "button";
            btn.textContent = subject;
            btn.onclick = () => {
                selectedSubject = subject;
                loadFiles();
            };
            content.appendChild(btn);
        });
    });
}

// ---- FILES ----
function loadFiles(){
    content.innerHTML = "";
    backBtn.style.display = "inline-block";

    db.collection("documents")
      .where("subject","==",selectedSubject)
      .get()
      .then(snapshot=>{
        if(snapshot.empty){
            content.innerHTML = "<p>No documents found for this subject</p>";
            return;
        }

        if(selectedSubject === "BIOLOGY"){
            // --- Biology: Grades → Main Topics → Files ---
            const grades = [...new Set(snapshot.docs.map(d => d.data().grade))].filter(g=>g).sort();
            if(!selectedGrade){
                // show grade buttons
                grades.forEach(grade=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = "Grade " + grade;
                    btn.onclick = () => {
                        selectedGrade = grade;
                        loadFiles();
                    };
                    content.appendChild(btn);
                });

                // All documents button
                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Grades";
                allBtn.onclick = () => {
                    selectedGrade = ""; // show all
                    loadFiles();
                };
                content.appendChild(allBtn);
                return;
            }

            // --- Main Topics ---
            const mainTopics = [...new Set(snapshot.docs
                .filter(d=>selectedGrade==="" || d.data().grade==selectedGrade)
                .map(d => d.data().mainTopic || ""))].filter(t=>t).sort();

            if(!selectedMainTopic && mainTopics.length>0){
                mainTopics.forEach(topic=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = topic;
                    btn.onclick = () => {
                        selectedMainTopic = topic;
                        loadFiles();
                    };
                    content.appendChild(btn);
                });

                // All Topics button
                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Topics";
                allBtn.onclick = () => {
                    selectedMainTopic = ""; // show all
                    loadFiles();
                };
                content.appendChild(allBtn);
                return;
            }

            // --- Show Files ---
            let files = snapshot.docs
                .filter(d=>{
                    const data = d.data();
                    const gradeMatch = selectedGrade === "" || data.grade == selectedGrade;
                    const topicMatch = selectedMainTopic === null || selectedMainTopic === "" || data.mainTopic == selectedMainTopic;
                    return gradeMatch && topicMatch;
                })
                .map(doc=>{
                    const data = doc.data();
                    return {
                        id: doc.id,
                        title: data.title,
                        link: data.link,
                        order: data.order || 999
                    };
                });

            files.sort((a,b)=>a.order - b.order);

            if(files.length === 0){
                content.innerHTML = "<p>No documents found for this selection</p>";
                return;
            }

            files.forEach(file=>{
                const card = document.createElement("div");
                card.className = "file-card";
                card.textContent = `${file.order !== 999 ? file.order + ". " : ""}${file.title}`;
                card.onclick = () => {
                    const id = extractDriveId(file.link);
                    if(id){
                        previewIframe.src = `https://drive.google.com/file/d/${id}/preview`;
                        previewContainer.style.display = "block";
                    } else {
                        alert("Invalid file link");
                    }
                };
                content.appendChild(card);
            });

        } else {
            // --- Other subjects ---
            // Collect unique main topics
            const mainTopics = [...new Set(snapshot.docs.map(d => d.data().mainTopic || ""))].filter(t=>t);
            mainTopics.sort();

            if(!selectedMainTopic && mainTopics.length>0){
                mainTopics.forEach(topic=>{
                    const btn = document.createElement("button");
                    btn.className = "button";
                    btn.textContent = topic;
                    btn.onclick = () => {
                        selectedMainTopic = topic;
                        loadFiles();
                    };
                    content.appendChild(btn);
                });

                const allBtn = document.createElement("button");
                allBtn.className = "button";
                allBtn.textContent = "All Documents";
                allBtn.onclick = () => {
                    selectedMainTopic = ""; // show all
                    loadFiles();
                };
                content.appendChild(allBtn);
            } else {
                // Show documents filtered by mainTopic
                let files = snapshot.docs.map(doc=>{
                    const data = doc.data();
                    return {
                        id: doc.id,
                        title: data.title,
                        link: data.link,
                        order: data.order || 999,
                        mainTopic: data.mainTopic || ""
                    };
                });

                if(selectedMainTopic !== null){
                    files = files.filter(f=>f.mainTopic === selectedMainTopic || selectedMainTopic === "");
                }

                files.sort((a,b)=>a.order - b.order);

                if(files.length === 0){
                    content.innerHTML = "<p>No documents found for this topic</p>";
                    return;
                }

                files.forEach(file=>{
                    const card = document.createElement("div");
                    card.className = "file-card";
                    card.textContent = `${file.order !== 999 ? file.order + ". " : ""}${file.title}`;
                    card.onclick = () => {
                        const id = extractDriveId(file.link);
                        if(id){
                            previewIframe.src = `https://drive.google.com/file/d/${id}/preview`;
                            previewContainer.style.display = "block";
                        } else {
                            alert("Invalid file link");
                        }
                    };
                    content.appendChild(card);
                });
            }
        }
    });
}

// ---- Google Drive ID ----
function extractDriveId(url){
    const match = url.match(/[-\w]{25,}/);
    return match ? match[0] : "";
}

// INIT
loadSubjects();
</script>

</body>
</html>